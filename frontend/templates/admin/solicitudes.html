{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/solicitudes.css') }}">

<!-- Script inline para prevenir flash del sidebar -->
<script>
(function() {
    if (window.innerWidth > 768 && localStorage.getItem('sidebarCollapsed') === 'true') {
        document.documentElement.classList.add('sidebar-collapsed-init');
    }
})();
</script>
 

<script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
<!-- Font Awesome ya está cargado en base.html -->
{% endblock %}

{% block title %}Solicitudes de Colaboración - Sign Tech{% endblock %}

{% block content %}
<div class="dashboard-container">
    <button class="menu-toggle">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <div class="dashboard-overlay"></div>

    {% include 'components/slider.html' %}

    <!-- CONTENIDO PRINCIPAL -->
    <main class="main-content">
        <!-- Flash messages ya incluidos en base.html, no duplicar -->

        <!-- Header con estadísticas -->
        <header class="page-header">
            <div class="header-left">
                <h1><i class="fas fa-user-plus"></i> Solicitudes de Colaboración</h1>
                <p class="subtitle">Gestiona las solicitudes para ser colaborador del sistema</p>
            </div>
            <div class="header-stats">
                <div class="stat-box">
                    <span class="stat-number">{{ pending_count }}</span>
                    <span class="stat-label">Pendientes</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number">{{ pagination.total }}</span>
                    <span class="stat-label">Total</span>
                </div>
            </div>
        </header>

        <!-- Filtros de ordenamiento -->
        <div class="filters-section">
            <div class="filter-group">
                <label class="filter-label">Ordenar por:</label>
                <a href="{{ url_for('solicitudes_bp.solicitudes_page', orden='reciente') }}" 
                   class="filter-btn {% if orden == 'reciente' or not orden %}active{% endif %}">
                    <i class="fas fa-arrow-down"></i> Más Recientes
                </a>
                <a href="{{ url_for('solicitudes_bp.solicitudes_page', orden='antigua') }}" 
                   class="filter-btn {% if orden == 'antigua' %}active{% endif %}">
                    <i class="fas fa-arrow-up"></i> Más Antiguas
                </a>
            </div>
        </div>

        <!-- Lista de solicitudes -->
        <div class="solicitudes-container">
            {% if solicitudes %}
                {% for solicitud in solicitudes %}
                <div class="solicitud-card" data-estado="{{ solicitud.estado }}">
                    <div class="solicitud-header">
                        <div class="solicitud-info">
                            <div class="solicitud-avatar">
                                {{ solicitud.nombre[0]|upper }}
                            </div>
                            <div class="solicitud-details">
                                <h3>{{ solicitud.nombre }}</h3>
                                <p class="solicitud-email">
                                    <i class="fas fa-envelope"></i> {{ solicitud.correo }}
                                </p>
                                <p class="solicitud-time">
                                    <i class="fas fa-clock"></i> {{ solicitud.time_ago }}
                                </p>
                            </div>
                        </div>
                        <span class="solicitud-status {{ solicitud.estado_class }}">
                            {{ solicitud.estado|capitalize }}
                        </span>
                    </div>

                    <div class="solicitud-body">
                        <h4><i class="fas fa-comment-dots"></i> Motivación</h4>
                        <p class="solicitud-motivacion">{{ solicitud.motivacion }}</p>
                        
                        {% if solicitud.ejemplo_media %}
                        <div class="solicitud-media">
                            <h4><i class="fas fa-file"></i> Archivo adjunto</h4>
                            <a href="{{ solicitud.ejemplo_media }}" target="_blank" class="media-link">
                                <i class="fas fa-download"></i> Ver archivo
                            </a>
                        </div>
                        {% endif %}

                        {% if solicitud.revisor_nombre %}
                        <div class="solicitud-revisor">
                            <i class="fas fa-user-check"></i>
                            <span>Revisado por: <strong>{{ solicitud.revisor_nombre }}</strong></span>
                        </div>
                        {% endif %}
                    </div>

                    {% if solicitud.estado == 'pendiente' %}
                    <div class="solicitud-actions">
                        <form method="POST" action="{{ url_for('solicitudes_bp.accept_solicitud', id_solicitud=solicitud.id_solicitud) }}" class="form-inline">
                            <button type="submit" class="btn-action btn-accept" onclick="return confirm('¿Aceptar esta solicitud? Se creará un usuario con rol GESTOR automáticamente.')">
                                <i class="fas fa-check"></i> Aceptar
                            </button>
                        </form>
                        <button type="button" class="btn-action btn-reject" 
                                data-id="{{ solicitud.id_solicitud }}" 
                                data-nombre="{{ solicitud.nombre }}">
                            <i class="fas fa-times"></i> Rechazar
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No hay solicitudes registradas</p>
                </div>
            {% endif %}
        </div>

        <!-- Paginación -->
        {% if pagination.total_pages > 1 %}
        <div class="pagination-container">
            <div class="pagination-info">
                Mostrando {{ ((pagination.page - 1) * pagination.per_page) + 1 }} 
                - {{ [pagination.page * pagination.per_page, pagination.total]|min }} 
                de {{ pagination.total }} solicitudes
            </div>
            <div class="pagination-controls">
                {% if pagination.has_prev %}
                <a href="{{ url_for('solicitudes_bp.solicitudes_page', page=pagination.page - 1, orden=orden) }}" 
                   class="pagination-btn">
                    <i class="fas fa-chevron-left"></i> Anterior
                </a>
                {% else %}
                <span class="pagination-btn disabled">
                    <i class="fas fa-chevron-left"></i> Anterior
                </span>
                {% endif %}

                <div class="pagination-pages">
                    {% for p in range(1, pagination.total_pages + 1) %}
                        {% if p == pagination.page %}
                        <span class="pagination-page active">{{ p }}</span>
                        {% elif p == 1 or p == pagination.total_pages or (p >= pagination.page - 2 and p <= pagination.page + 2) %}
                        <a href="{{ url_for('solicitudes_bp.solicitudes_page', page=p, orden=orden) }}" 
                           class="pagination-page">{{ p }}</a>
                        {% elif p == pagination.page - 3 or p == pagination.page + 3 %}
                        <span class="pagination-ellipsis">...</span>
                        {% endif %}
                    {% endfor %}
                </div>

                {% if pagination.has_next %}
                <a href="{{ url_for('solicitudes_bp.solicitudes_page', page=pagination.page + 1, orden=orden) }}" 
                   class="pagination-btn">
                    Siguiente <i class="fas fa-chevron-right"></i>
                </a>
                {% else %}
                <span class="pagination-btn disabled">
                    Siguiente <i class="fas fa-chevron-right"></i>
                </span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </main>
</div>

<!-- Modal de rechazo -->
<div id="rejectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-times-circle"></i> Rechazar Solicitud</h2>
            <button class="close-modal" onclick="closeRejectModal()">&times;</button>
        </div>
        <form id="rejectForm" method="POST" action="">
            <div class="modal-body">
                <p class="modal-text">Estás rechazando la solicitud de: <strong id="solicitanteNombre"></strong></p>
                <div class="form-group">
                    <label for="motivoRechazo">Motivo del rechazo *</label>
                    <textarea id="motivoRechazo" name="motivo_rechazo" rows="5" required 
                              placeholder="Explica por qué se rechaza esta solicitud. Este motivo se enviará por email al solicitante."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeRejectModal()">Cancelar</button>
                <button type="submit" class="btn btn-danger"><i class="fas fa-times"></i> Rechazar Solicitud</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/solicitudes.js') }}"></script>
{% endblock %}
