{% extends 'base.html' %}

{% block title %}Notificaciones - Sistema LSC{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notifications.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Botón hamburguesa para móvil -->
    <button class="menu-toggle">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Overlay para cerrar menú en móvil -->
    <div class="dashboard-overlay"></div>

    <!-- Incluir Sidebar -->
    {% include 'components/slider.html' %}

    <!-- Contenido principal -->
    <main class="main-content">
        <div class="notifications-container">
    <!-- Flash messages ya incluidos en base.html, no duplicar -->

    <div class="notifications-header">
        <div class="header-left">
            <h1><i class="fas fa-bell"></i> Notificaciones</h1>
            <p class="subtitle">Gestiona tus alertas y mensajes del sistema</p>
        </div>
        <div class="header-actions">
            {% if unread_count > 0 %}
            <form method="POST" action="{{ url_for('notifications_bp.mark_all_as_resolved') }}" 
                  onsubmit="return confirm('¿Marcar todas las alertas pendientes como resueltas?')" class="form-inline">
                <button type="submit" class="btn-mark-all">
                    <i class="fas fa-check-double"></i>
                    Marcar todas como resueltas
                </button>
            </form>
            {% endif %}
            
            <!-- Nuevo botón: Eliminar resueltas -->
            {% if alertas|selectattr('estado', 'equalto', 'resuelto')|list|length > 0 %}
            <form method="POST" action="{{ url_for('notifications_bp.delete_all_resolved') }}" 
                  onsubmit="return confirm('¿Estás seguro de eliminar todas las alertas resueltas? Esta acción no se puede deshacer.')" class="form-inline">
                <button type="submit" class="btn-delete-resolved">
                    <i class="fas fa-trash-restore"></i>
                    Eliminar resueltas ({{ alertas|selectattr('estado', 'equalto', 'resuelto')|list|length }})
                </button>
            </form>
            {% endif %}
            
            {% if alertas %}
            <form method="POST" action="{{ url_for('notifications_bp.delete_all_notifications') }}" 
                  onsubmit="return confirm('⚠️ ¿Estás seguro de eliminar TODAS las alertas? Esta acción no se puede deshacer.')" class="form-inline">
                <button type="submit" class="btn-delete-all">
                    <i class="fas fa-trash-alt"></i>
                    Eliminar todas
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Contador de alertas -->
    {% if unread_count > 0 %}
    <div class="alert-counter">
        <i class="fas fa-exclamation-circle"></i>
        Tienes <strong>{{ unread_count }}</strong> alerta{{ 's' if unread_count != 1 else '' }} pendiente{{ 's' if unread_count != 1 else '' }}
    </div>
    {% endif %}

    <!-- Lista de notificaciones -->
    <div class="notifications-list">
        {% if alertas %}
            {% for alerta in alertas %}
            <div class="notification-card {% if alerta.estado != 'resuelto' %}unread{% endif %}">
                <!-- Icono según severidad -->
                <div class="notification-icon 
                    {% if alerta.severidad == 'crítico' %}error
                    {% elif alerta.severidad == 'alto' %}warning
                    {% elif alerta.estado == 'resuelto' %}success
                    {% else %}info{% endif %}">
                    <i class="fas 
                        {% if alerta.severidad == 'crítico' %}fa-times-circle
                        {% elif alerta.severidad == 'alto' %}fa-exclamation-triangle
                        {% elif alerta.estado == 'resuelto' %}fa-check-circle
                        {% else %}fa-info-circle{% endif %}">
                    </i>
                </div>

                <div class="notification-content">
                    <div class="notification-header-row">
                        <h3 class="notification-title">
                            [{{ alerta.modulo.upper() }}] {{ alerta.tipo_error }}
                        </h3>
                        <div class="notification-badges">
                            <span class="badge badge-{{ alerta.severidad }}">{{ alerta.severidad.upper() }}</span>
                            <span class="badge badge-estado-{{ alerta.estado.replace(' ', '-') }}">{{ alerta.estado.upper() }}</span>
                        </div>
                    </div>
                    
                    <p class="notification-message">{{ alerta.descripcion }}</p>
                    
                    <p class="notification-module">Módulo: <strong>{{ alerta.modulo }}</strong></p>
                    <p class="notification-severity">Severidad: <strong>{{ alerta.severidad }}</strong></p>
                    
                    <div class="notification-time">
                        <i class="far fa-clock"></i>
                        <span>{{ alerta.fecha.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                </div>

                <div class="notification-actions">
                    <!-- Selector de estado -->
                    {% if alerta.estado != 'resuelto' %}
                    <form method="POST" action="{{ url_for('notifications_bp.change_alert_status', notification_id=alerta.id_alerta) }}" class="status-form">
                        <select name="estado" class="status-dropdown" onchange="this.form.submit()">
                            <option value="">Cambiar estado...</option>
                            <option value="pendiente" {% if alerta.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                            <option value="en revisión" {% if alerta.estado == 'en revisión' %}selected{% endif %}>En Revisión</option>
                            <option value="resuelto">Resolver</option>
                        </select>
                    </form>
                    {% endif %}

                    <!-- Botón eliminar -->
                    <form method="POST" action="{{ url_for('notifications_bp.delete_notification', notification_id=alerta.id_alerta) }}" 
                          onsubmit="return confirm('¿Estás seguro de eliminar esta alerta?')" class="form-inline">
                        <button type="submit" class="notification-btn btn-delete" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No hay notificaciones en el sistema</p>
            </div>
        {% endif %}
    </div>
</div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script>
    // Actualizar badges inmediatamente al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        // Esperar un momento para que el DOM esté completamente cargado
        setTimeout(function() {
            if (typeof updateAllNotificationBadges === 'function') {
                updateAllNotificationBadges();
            }
        }, 100);
    });
</script>
{% endblock %}
