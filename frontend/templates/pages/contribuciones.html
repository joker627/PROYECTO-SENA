{% extends 'base_admin.html' %}

{% block title %}Contribuciones - Sign Technology{% endblock %}
{% block page_id %}contribuciones{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/contribuciones.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Gestión de Contribuciones</h1>
    <p>Administra y revisa las contribuciones de los usuarios</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-info">
            <p>Total Contribuciones</p>
            <div class="stat-value">{{ stats.total }}</div>
        </div>
        <div class="stat-icon purple"><span class="material-icons">volunteer_activism</span></div>
    </div>
    <div class="stat-card">
        <div class="stat-info">
            <p>Pendientes</p>
            <div class="stat-value yellow">{{ stats.pendientes }}</div>
        </div>
        <div class="stat-icon yellow"><span class="material-icons">schedule</span></div>
    </div>
    <div class="stat-card">
        <div class="stat-info">
            <p>Aprobadas</p>
            <div class="stat-value green">{{ stats.aprobadas }}</div>
        </div>
        <div class="stat-icon green"><span class="material-icons">check_circle</span></div>
    </div>
</div>

<div class="filters-card">
    <form action="{{ url_for('contribuciones') }}" method="GET" class="filters-grid">
        <div class="form-group">
            <label>Buscar</label>
            <input type="text" name="query" placeholder="Palabra, descripción o usuario..."
                value="{{ filter_query or '' }}">
        </div>
        <div class="form-group">
            <label>Estado</label>
            <select name="estado" onchange="this.form.submit()">
                <option value="todos">Todas</option>
                <option value="pendiente" {% if active_filter=='pendiente' %}selected{% endif %}>Pendientes
                </option>
                <option value="aprobada" {% if active_filter=='aprobada' %}selected{% endif %}>Aprobadas
                </option>
                <option value="rechazada" {% if active_filter=='rechazada' %}selected{% endif %}>Rechazadas
                </option>
            </select>
        </div>
    </form>
</div>

<div class="table-card">
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Palabra</th>
                    <th>Descripción</th>
                    <th>Video</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% if contribuciones %}
                {% for item in contribuciones %}
                <tr>
                    <td data-label="Usuario">
                        <div class="user-cell">
                            <div class="avatar">{{ item.nombre_usuario[0]|upper if item.nombre_usuario else 'U' }}
                            </div>
                            <div class="name">
                                <div>{{ item.nombre_usuario or 'Cargando...' }}</div>
                                <div style="font-size: 0.75rem; color: #64748b;">Colaborador</div>
                            </div>
                        </div>
                    </td>
                    <td data-label="Palabra" style="font-weight: 600; color: #0f172a;">{{ item.palabra_asociada }}</td>
                    <td data-label="Descripción">{{ item.descripcion[:50] }}{{ '...' if item.descripcion|length > 50 }}
                    </td>
                    <td data-label="Video">
                        {% if item.archivo_video %}
                        <span class="material-icons" style="color: #6366f1; font-size: 20px;">videocam</span>
                        {% else %}
                        <span class="material-icons" style="color: #cbd5e1; font-size: 20px;">videocam_off</span>
                        {% endif %}
                    </td>
                    <td data-label="Fecha">{{ item.fecha_contribucion[:10] }}</td>
                    <td data-label="Estado">
                        <span class="badge {{ item.estado }}">{{ item.estado|capitalize }}</span>
                    </td>
                    <td data-label="Acciones">
                        <div class="actions-cell">
                            <button class="btn-icon view" title="Ver Detalles" onclick="openViewModal(this)"
                                data-usuario="{{ item.nombre_usuario or 'Anónimo' }}"
                                data-palabra="{{ item.palabra_asociada }}" data-descripcion="{{ item.descripcion }}"
                                data-fecha="{{ item.fecha_contribucion }}" data-estado="{{ item.estado }}"
                                data-video="{{ item.archivo_video }}"
                                data-fecha_gestion="{{ item.fecha_gestion or '' }}"
                                data-observaciones="{{ item.observaciones_gestion or '' }}">
                                <span class="material-icons">visibility</span>
                            </button>

                            {% if item.estado == 'pendiente' %}
                            <button class="btn-icon check" title="Gestionar" onclick="openManageModal(this)"
                                data-id="{{ item.id_contribucion }}" data-palabra="{{ item.palabra_asociada }}">
                                <span class="material-icons">gavel</span>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 4rem;">
                        <span class="material-icons"
                            style="font-size: 48px; color: #cbd5e1; margin-bottom: 1rem;">volunteer_activism</span>
                        <p style="color: #64748b;">No hay contribuciones registradas para los filtros seleccionados.</p>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Visualización -->
<div class="modal" id="viewModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Detalles de Contribución</h2>
            <button class="btn-icon" onclick="closeModal('viewModal')"><span
                    class="material-icons">close</span></button>
        </div>
        <div class="modal-body">
            <div class="view-modal-grid">
                <!-- Columna Izquierda: Video -->
                <div class="view-video-section">
                    <label><span class="material-icons">videocam</span> Previsualización de la Seña</label>
                    <div class="video-container-premium">
                        <video id="view_video" controls></video>
                    </div>
                </div>

                <!-- Columna Derecha: Info -->
                <div class="view-info-section">
                    <div class="view-header-alt">
                        <div class="view-avatar" id="view_avatar">U</div>
                        <div class="view-title-group">
                            <h3 id="view_palabra">-</h3>
                            <p id="view_usuario">Enviado por: -</p>
                        </div>
                    </div>

                    <div class="view-details-list">
                        <div class="view-item">
                            <label><span class="material-icons">description</span> Descripción</label>
                            <p id="view_descripcion" class="view-value">-</p>
                        </div>

                        <div class="view-row">
                            <div class="view-item">
                                <label><span class="material-icons">calendar_today</span> Envío</label>
                                <p id="view_fecha" class="view-value">-</p>
                            </div>
                            <div class="view-item">
                                <label><span class="material-icons">info</span> Estado</label>
                                <div id="view_estado_container" style="margin-top: 0.25rem;"></div>
                            </div>
                        </div>

                        <div class="view-item" id="view_gestion_item" style="display: none;">
                            <label><span class="material-icons">history</span> Gestión el</label>
                            <p id="view_fecha_gestion" class="view-value">-</p>
                        </div>

                        <div class="view-item" id="view_obs_item" style="display: none;">
                            <label><span class="material-icons">comment</span> Observaciones</label>
                            <p id="view_observaciones" class="view-value">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('viewModal')">
                Cerrar
            </button>
        </div>
    </div>
</div>

<!-- Modal Gestión -->
<div class="modal" id="manageModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Gestionar Contribución</h2>
            <button class="btn-icon" onclick="closeModal('manageModal')"><span
                    class="material-icons">close</span></button>
        </div>
        <form action="{{ url_for('update_contribucion') }}" method="POST">
            <div class="modal-body">
                <input type="hidden" name="id_contribucion" id="manage_id">
                <p style="margin-bottom: 1.5rem; color: #475569;">Estás revisando la palabra: <strong
                        id="manage_palabra"></strong></p>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Acción a Tomar</label>
                    <select name="nuevo_estado" required style="width: 100%;" onchange="toggleObs(this.value)">
                        <option value="aprobada">Aprobar Contribución</option>
                        <option value="rechazada">Rechazar Contribución</option>
                    </select>
                </div>

                <div class="form-group" id="obs_group">
                    <label>Observaciones (Opcional)</label>
                    <textarea name="observaciones" placeholder="Escribe el motivo del rechazo o sugerencias..."
                        style="width: 100%; padding: 0.75rem; border-radius: 12px; border: 1px solid #e2e8f0; min-height: 100px; font-family: inherit;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('manageModal')">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons" style="font-size: 18px;">save</span>
                    Confirmar Acción
                </button>
            </div>
        </form>
    </div>
</div>

<div class="pagination">
    {% if page > 1 %}
    <a href="{{ url_for('contribuciones', page=page-1, estado=active_filter, query=filter_query) }}"
        class="btn-secondary">Anterior</a>
    {% endif %}
    <div class="page-numbers">
        {% for p in range(1, total_pages + 1) %}
        <a href="{{ url_for('contribuciones', page=p, estado=active_filter, query=filter_query) }}"
            class="page-link {{ 'active' if p == page else '' }}">
            {{ p }}
        </a>
        {% endfor %}
    </div>
    {% if page < total_pages %} <a
        href="{{ url_for('contribuciones', page=page+1, estado=active_filter, query=filter_query) }}"
        class="btn-secondary">Siguiente</a>
        {% endif %}
</div>
{% endblock %}