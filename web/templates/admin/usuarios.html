{% extends "base/base.html" %}

{% block title %}Gestionar Usuarios{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/usuarios.css') }}">
{% endblock %}

{% block content %}
{% include "components/slider.html" %}
<main>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div>
                <h1>Usuarios</h1>
                <div class="muted">Administrar colaboradores y administradores</div>
            </div>
        </div>

        <div class="main-card">
            <div class="card-header">
                <h2>Lista de usuarios</h2>
                <div class="header-info">
                    <div class="user-count">Mostrando {{ usuarios|length }} usuarios</div>
                </div>
            </div>
            <div class="card-muted">
                <section class="search-section">
                    <form class="search-form" method="get" action="{{ url_for('web_admin.admin_usuarios') }}">
                        <div class="search-container">
                            <span class="search-icon"><i class="fas fa-search"></i></span>
                            <input aria-label="Buscar usuarios" type="search" name="search" class="search-input" placeholder="Buscar por nombre, correo o ID..." value="{{ search or '' }}">
                            {% if search %}
                                <a href="{{ url_for('web_admin.admin_usuarios') }}" class="search-clear" aria-label="Limpiar búsqueda"><i class="fas fa-times"></i>&nbsp;Limpiar</a>
                            {% endif %}
                        </div>
                    </form>
                    {% if search and usuarios|length == 0 %}
                        <div class="no-results" style="margin-top:12px;">
                            <h3>No se encontraron usuarios</h3>
                            <p>Prueba con otra búsqueda o <a href="{{ url_for('web_admin.admin_usuarios') }}">limpia la búsqueda</a>.</p>
                        </div>
                    {% endif %}
                </section>
                <!-- New responsive card grid for users -->
                {% if usuarios and usuarios|length > 0 %}
                <div class="user-grid">
                    {% for usuario in usuarios %}
                    <article class="user-card" data-user-id="{{ usuario.id_usuario }}" aria-label="Usuario {{ usuario.nombre_completo }}">
                        <div class="card-left">
                            <div class="avatar" aria-hidden="true">{{ usuario.nombre_completo[0]|upper }}</div>
                            <div class="user-meta">
                                <div class="user-name">{{ usuario.nombre_completo }}</div>
                                <div class="user-email">{{ usuario.correo }}</div>
                                <div class="muted small">ID: {{ usuario.id_usuario }}</div>
                            </div>
                        </div>

                        <div class="card-right">
                            <div class="badges">
                                <span class="role-badge role-{{ usuario.id_rol }}">R{{ usuario.id_rol }}</span>
                                <span class="status-badge status-{{ usuario.estado|lower }}">{{ usuario.estado }}</span>
                            </div>

                            <div class="actions-cell">
                                <a class="btn-action btn-edit" href="#" title="Editar usuario {{ usuario.nombre_completo }}"><i class="fas fa-edit"></i>&nbsp;Editar</a>
                                {% set can_delete = false %}
                                {% if session.user_id != usuario.id_usuario %}
                                    {% if session.rol == 3 %}
                                        {% set can_delete = true %}
                                    {% elif session.rol == 1 and usuario.id_rol == 2 %}
                                        {% set can_delete = true %}
                                    {% endif %}
                                {% endif %}

                                {% if can_delete %}
                                    <form method="POST" action="{{ url_for('web_admin.delete_usuario', id_usuario=usuario.id_usuario) }}" class="inline-form" aria-label="Eliminar usuario {{ usuario.nombre_completo }}">
                                        <button type="submit" class="btn-action btn-delete" onclick="return confirm('¿Eliminar usuario? Esta acción no es reversible.')" title="Eliminar usuario {{ usuario.nombre_completo }}"><i class="fas fa-trash"></i>&nbsp;Eliminar</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-users muted">No hay usuarios disponibles.</div>
                {% endif %}
            </div>
        </div>
    </div>
</main>
{% endblock %}