{% extends "base/base.html" %}

{% block title %}Reportes de errores{% endblock %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/contribuciones.css') }}">

{% block content %}
    {% include "components/slider.html" %}
<main>
    <div class="dashboard-container">
        <div class="dashboard-header">
                <div>
                    <h1>Reportes de errores</h1>
                    <div class="muted">Reportes enviados por usuarios</div>
                </div>
                <div style="display:flex;align-items:center;gap:12px;">
                    <div class="muted">Mostrando: {% if current_filter == 'pendiente' %}Pendientes{% elif current_filter == 'en_revision' %}En revisión{% else %}Pendientes + En revisión{% endif %}</div>
                    <div>
                        <a class="btn-approve" href="{{ url_for('web_admin.reportes', estado='pendiente') }}">Pendientes</a>
                        <a class="btn-approve" href="{{ url_for('web_admin.reportes', estado='en_revision') }}">En revisión</a>
                        <a class="btn-approve" href="{{ url_for('web_admin.reportes') }}">Todos</a>
                    </div>
                </div>
            </div>

        <div class="main-card">
            <h2>Reportes pendientes</h2>
            <div class="card-muted">
                <table class="table-list" id="reportes-table">
                    <thead>
                        <tr><th>ID</th><th>Tipo</th><th>Descripción</th><th>Evidencia</th><th>Prioridad</th><th>Fecha</th><th>Estado</th><th>Acciones</th></tr>
                    </thead>
                    <tbody>
                        {% if reportes and reportes|length > 0 %}
                            {% for r in reportes %}
                            <tr id="reporte-{{ r.id_reporte }}">
                                <td>{{ r.id_reporte }}</td>
                                <td>{{ r.tipo_traduccion or '-' }}</td>
                                <td>{{ r.descripcion_error[:120] }}{% if r.descripcion_error|length > 120 %}...{% endif %}</td>
                                <td>{% if r.evidencia_url %}<a href="{{ r.evidencia_url }}" target="_blank">ver</a>{% else %}-{% endif %}</td>
                                <td>{{ r.prioridad or 'media' }}</td>
                                <td>{{ r.fecha_reporte }}</td>
                                <td>{{ r.estado }}</td>
                                <td>
                                    {% if r.estado == 'pendiente' %}
                                        <button class="btn-approve" data-id="{{ r.id_reporte }}">Poner en revisión</button>
                                    {% endif %}
                                    <button class="btn-delete" data-id="{{ r.id_reporte }}">Eliminar</button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="7">No hay reportes pendientes.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('click', function(e){
    // Put in review
    if(e.target && e.target.matches('.btn-approve')){
        const id = e.target.dataset.id;
        if(!confirm('¿Marcar reporte #' + id + ' como "en revisión"?')) return;
        fetch('/admin/reportes/review/' + id, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(r => r.json())
        .then(j => {
            if(j.status === 'ok'){
                // reflect server change by reloading page
                window.location.reload();
            } else {
                alert('Error al actualizar');
            }
        }).catch(()=> alert('Error de red'));
    }

    // Delete
    if(e.target && e.target.matches('.btn-delete')){
        const id = e.target.dataset.id;
        if(!confirm('¿Eliminar reporte #' + id + '? Esta acción no se puede deshacer.')) return;
        fetch('/admin/reportes/delete/' + id, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(r => r.json())
        .then(j => {
            if(j.status === 'ok'){
                window.location.reload();
            } else {
                alert('Error al eliminar');
            }
        }).catch(()=> alert('Error de red'));
    }
});
</script>

{% endblock %}
